# SQL 小技巧

#### 🔥Hive SQL行转列

```text
转换之前的水果订单表，现在需要按天统计每个水果的销售数量
+------------+--------+---------+
|   date     |  type  |  value  |
+------------+--------+---------+
| 2023-02-11 | apple  |   10    |
+------------+--------+---------+
| 2023-02-11 | orange |   15    |
+------------+--------+---------+
| 2023-02-11 | banana |   6     |
+------------+--------+---------+
| 2023-02-11 | mango  |   12    |
+------------+--------+---------+
| 2023-02-11 | apple  |   20    |
+------------+--------+---------+
| 2023-02-12 | mango  |   4     |
+------------+--------+---------+
| 2023-02-12 | mango  |   12    |
+------------+--------+---------+

期望结果
+------------+--------+--------+--------+-------+
|   date     | appele | orange | banana | mango |
+------------+--------+--------+--------+-------+
| 2023-02-11 |   30   |   15   |   6    |   12  |
+------------+--------+--------+--------+-------+
| 2023-02-12 |   4    |   0    |   0    |   18  |
+------------+--------+--------+--------+-------+

```

转换之前的水果订单表，现在需要按天统计每个水果的销售数量

```sql
SELECT fo.`date`,
       SUM(if(fo.`type` = 'apple',fo.value,0)) as apple,
       SUM(if(fo.`type` = 'orange',fo.value,0)) as orange,
       SUM(if(fo.`type` = 'banana',fo.value,0)) as banana,
       SUM(if(fo.`type` = 'mango',fo.value,0)) as mango
FROM Fruit_Order fo
GROUP BY fo.`date` ;
```

#### 🔥Hive SQL列转行

```text
Price 价目表中month_code代表年月，a/b是产品，cn/en是产地
+----------+------+------+------+------+
|month_code| a_cn | a_en | b_cn | b_en |
+----------+------+------+------+------+
|  202303  |  10  |  15  |  20  |  25  |
+----------+------+------+------+------+
|  202304  |  20  |  17  |  22  |  14  |
+----------+------+------+------+------+

期望结果
+----------+------+------+------+
|month_code| item |  cn  |  en  |
+----------+------+------+------+
|  202303  |  a   |  10  |  15  |
+----------+------+------+------+
|  202303  |  b   |  20  |  25  |
+----------+------+------+------+
|  202304  |  a   |  20  |  17  |
+----------+------+------+------+
|  202304  |  b   |  22  |  14  |
+----------+------+------+------+

```

这里使用 `lateral view explode`处理，代码如下

```sql
select
  month_code,
  info.col1 as item,
  info.col2[0] as cn,
  info.col2[1] as en
from
  (
    select
      month_code,
      array(
          struct('a',array(a_cn,a_en)),
          struct('b',array(b_cn,b_en))) as arr
    from
      Price
  ) as tmp
lateral view explode(arr) tmp2 as info
```

#### 找条件筛选后连续id

\*\*\[Leetcode601 体育馆的人流量] \*\*写SQL找出每行的人数大于或等于 100且 id连续的三行或更多行记录，示例如下：

```text
Stadium
+------+------------+-----------+
| id   | visit_date | people    |
+------+------------+-----------+
| 1    | 2017-01-01 | 10        |
| 2    | 2017-01-02 | 109       |
| 3    | 2017-01-03 | 150       |
| 4    | 2017-01-04 | 99        |
| 5    | 2017-01-05 | 145       |
| 6    | 2017-01-06 | 1455      |
| 7    | 2017-01-07 | 199       |
| 8    | 2017-01-09 | 188       |
+------+------------+-----------+

期望结果
+------+------------+-----------+
| id   | visit_date | people    |
+------+------------+-----------+
| 5    | 2017-01-05 | 145       |
| 6    | 2017-01-06 | 1455      |
| 7    | 2017-01-07 | 199       |
| 8    | 2017-01-09 | 188       |
+------+------------+-----------+

```

`id - row_number() over(order by id)`，where筛选后用row\_number( )排序，筛选后 连续的行id-row\_number( )相同

```sql
select *,id - row_number() over(order by id) as rk
from stadium
where people >= 100

"""
| id | visit_date | people | rk |
| -- | ---------- | ------ | -- |
| 2  | 2017-01-02 | 109    | 1  |
| 3  | 2017-01-03 | 150    | 1  |
| 5  | 2017-01-05 | 145    | 2  |
| 6  | 2017-01-06 | 1455   | 2  |
| 7  | 2017-01-07 | 199    | 2  |
| 8  | 2017-01-09 | 188    | 2  |
"""
```
